error_log /var/log/nginx/error.log debug;
worker_processes  auto;

events {
  worker_connections  1024;
}

daemon off;

http {

  include 	mime.types;
  include		nginx-gz.conf;
  resolver 	master.mesos valid=1s;  #use local DNS and override TTL to whatever value makes sense
  resolver_timeout 2s;
  client_max_body_size 30M;

  upstream album_manager {
    server        marathon.mesos service=album-manager resolve;
    #server album-manager.ngra.ps.nginxlab.com resolve;
    zone backend  64k;
    least_time 		last_byte;
    keepalive 		300;
  }

  upstream uploader {
    server        marathon.mesos service=uploader resolve;
    #server album-manager.ngra.ps.nginxlab.com resolve;
    zone backend  64k;
    least_time 		last_byte;
    keepalive 		300;
  }

  upstream user_manager {
    server 			  marathon.mesos service=user-manager resolve;
    #server user-manager.ngra.ps.nginxlab.com resolve;
    zone backend 	64k;
    least_time 		last_byte;
    keepalive 		300;
  }

  server {
    listen 80;

    location /account/users/ {
      proxy_pass https://user_manager/v1/users/;
        proxy_set_header Host user-manager.marathon.mesos;

      proxy_ssl_session_reuse     on;
      proxy_ssl_protocols         TLSv1.2;
      #proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
      proxy_ssl_verify            off;
      proxy_read_timeout          3600;
      proxy_connect_timeout       3600;

      # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Accept-Encoding "";

      #allow 173.186.135.1/24;
      #allow 127.0.0.1;
      #deny  all;
    }

    location /albums {
      proxy_set_header Host album-manager.marathon.mesos;
      proxy_pass https://album_manager/albums;

        proxy_ssl_session_reuse 	on;
      proxy_ssl_protocols       TLSv1.2;
      #proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
      proxy_ssl_verify 			    off;
      proxy_read_timeout     		3600s;
      proxy_connect_timeout  		3600s;

      # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Accept-Encoding "";

      #allow 173.186.135.1/24;
      #allow 127.0.0.1;
      #deny  all;
    }

    location /user-manager/ {
      proxy_set_header Host user-manager.marathon.mesos;
      proxy_pass https://user_manager/v1/users;

        proxy_ssl_session_reuse 	on;
      proxy_ssl_protocols       TLSv1.2;
      #proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
      proxy_ssl_verify 			    off;
      proxy_read_timeout     		3600s;
      proxy_connect_timeout  		3600s;

      # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Accept-Encoding "";

      #allow 173.186.135.1/24;
      #allow 127.0.0.1;
      #deny  all;
    }

    location / {
      return         301 https://$host$request_uri;
    }

  }

  server {
    listen       443 ssl;

    ssl_certificate      /etc/ssl/nginx/certificate.pem;
    ssl_certificate_key  /etc/ssl/nginx/key.pem;
    ## verify chain of trust of OCSP response using Root CA and Intermediate certs
    #ssl_trusted_certificate /etc/letsencrypt/live/inginious.ps.nginxlab.com/chain.pem;
    include nginx-ssl.conf;


    keepalive_timeout	3600s;
    keepalive_disable	none;
    keepalive_requests  100000;

    server_name pages.marathon.mesos;
    status_zone pages;

    root            /inginious-pages/web;

    ## Default location
    location / {
      # try to serve file directly, fallback to app.php
      try_files $uri /app.php$is_args$args;
    }

    location /account/users/ {
      proxy_pass https://user_manager/v1/users/;
        proxy_set_header Host user-manager.marathon.mesos;

      #proxy_pass http://user_manager/v1/users/;
      #proxy_set_header Host user-manager.ngra.ps.nginxlab.com;

      proxy_ssl_session_reuse     on;
      proxy_ssl_protocols         TLSv1.2;
      #proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
      proxy_ssl_verify            off;
      proxy_read_timeout          3600;
      proxy_connect_timeout       3600;

      # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Accept-Encoding "";

      #allow 173.186.135.1/24;
      #allow 127.0.0.1;
      #deny  all;
    }

    location /uploader/image {
      # try to serve file directly, fallback to app.php
      proxy_set_header Host uploader.marathon.mesos;
      proxy_pass https://uploader/image;

      #proxy_set_header Host uploader.ngra.ps.nginxlab.com;
      #proxy_pass http://uploader/image;
      #proxy_set_header "Auth-ID" $upstream_http_auth_id;

        proxy_ssl_session_reuse 	  on;
      proxy_ssl_protocols         TLSv1.2;
      #proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
      proxy_ssl_verify 			      off;
      proxy_read_timeout     		  3600s;
      proxy_connect_timeout  		  3600s;

      # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Accept-Encoding "";
    }

    location /uploader/album {
      proxy_set_header Host uploader.marathon.mesos;
      proxy_pass https://uploader/album;

      #proxy_set_header Host uploader.ngra.ps.nginxlab.com;
      #proxy_pass http://uploader/album;
      #proxy_set_header "Auth-ID" $upstream_http_auth_id;

        proxy_ssl_session_reuse 	on;
      proxy_ssl_protocols         TLSv1.2;
      #proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
      proxy_ssl_verify 			    off;
      proxy_read_timeout     		3600s;
      proxy_connect_timeout  		3600s;

      # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Accept-Encoding "";
    }

    location /albums {
      proxy_set_header Host album-manager.marathon.mesos;
      proxy_pass https://album_manager/albums;

      #proxy_pass http://album_manager/albums;
      #proxy_set_header Host album-manager.ngra.ps.nginxlab.com;

        proxy_ssl_session_reuse 	on;
      proxy_ssl_protocols         TLSv1.2;
      #proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
      proxy_ssl_verify 			off;
      proxy_read_timeout     		3600s;
      proxy_connect_timeout  		3600s;

      # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Accept-Encoding "";
    }

    location ~ "^(.+\.php)($|/)" {
      fastcgi_split_path_info ^(.+\.php)(.*)$;

      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_param SCRIPT_NAME $fastcgi_script_name;
      fastcgi_param PATH_INFO $fastcgi_path_info;
      fastcgi_pass unix:/var/run/php5-fpm.sock;
      include fastcgi_params;
    }

    location = /status.html {
      root /usr/share/nginx/html/;
    }

    location /status {
      status;
    }

  }
}
